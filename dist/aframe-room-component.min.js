!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var o=t();for(var n in o)("object"==typeof exports?exports:e)[n]=o[n]}}(self,(()=>(()=>{"use strict";function e(e){e&&e.systems.building&&e.systems.building.reexamineBuilding()}function t(t){"position"===t.detail.name&&e(t.detail.target.sceneEl)}AFRAME.registerSystem("building",{reexamineBuilding:function(){var e=this,t=1e-4;function o(e){for(var t=e.index,o=0;o<t.count/3;o++){var n=t[3*o+2];t[3*o+2]=t[3*o+1],t[3*o+1]=n}e.setIndex(t)}function n(e,t){for(var o=[],n=0;n<e.index.array.length;n++){var r=e.index.array[n],i=t(new THREE.Vector3(e.attributes.position.getX(r),e.attributes.position.getY(r),e.attributes.position.getZ(r)),n%3);o[2*r+0]=i[0],o[2*r+1]=i[1]}e.setAttribute("uv",new THREE.BufferAttribute(new Float32Array(o),2)),e.uvsNeedUpdate=!0}function r(e,t,o,r,i){n(e,(function(e){return[e[t]*r,e[o]*i]}))}function i(e){e.computeVertexNormals(),e.computeBoundingBox(),e.computeBoundingSphere()}function a(e){for(var t=[],o=0;o<e.children.length;o++){var n=e.children[o];n.components.wall&&t.push(n)}return t}function s(e){for(var t=e.components.room.data.outside,o=a(e),n=0,r=0;r<o.length;r++){var i=o[r],s=o[(r+1)%o.length],l=i.components.position.data,m=s.components.position.data;n+=(m.x-l.x)*(m.z+l.z)}var c=!1;return n>0&&(c=!c),t&&(c=!c),c&&o.reverse(),o}var l=new THREE.Vector3,m=new THREE.Vector3,c=new THREE.Vector3;function p(e,o){var n,r,i,a=e.parentNode,p=(i=(r=s((n=a).parentNode)).indexOf(n),r[(i+1)%r.length]);if(p){a.object3D.getWorldPosition(l),p.object3D.getWorldPosition(m),o.object3D.getWorldPosition(c);var d=c.x-l.x,h=c.z-l.z,u=m.x-l.x,f=m.z-l.z,g=Math.atan2(f,u),v=Math.sqrt(u*u+f*f),y=d*Math.cos(-g)-h*Math.sin(-g),E=o.components.doorlink.data.width/2;y=Math.max(y,E+t),y=Math.min(y,v-E-t),e.setAttribute("position",{x:y,y:0,z:0}),e.object3D.updateMatrixWorld()}}function d(t){for(var o=e.el.querySelectorAll("[doorlink]"),n=0;n<o.length;n++){var r=o[n];if(r.components.doorlink.data.from===t)return r;if(r.components.doorlink.data.to===t)return r}}function h(e){return e.components.wall.data.height?e.components.wall.data.height:e.parentNode.components.room.data.height}e.dirty||(e.dirty=!0,setTimeout((function(){e.el.object3D.updateMatrixWorld();for(var l=0;l<e.el.children.length;l++){var m=e.el.children[l];if(m.components&&m.components.room){var c=m.components.room.data.width,u=m.components.room.data.length;if(c||u)if(c&&u){var f=a(m);f.length>=4?(f.length>4&&console.error("rooms with WIDTH and LENGTH should only have four walls!"),f[0].setAttribute("position",{x:0,y:0,z:0}),f[1].setAttribute("position",{x:c,y:0,z:0}),f[2].setAttribute("position",{x:c,y:0,z:u}),f[3].setAttribute("position",{x:0,y:0,z:u})):console.error("rooms with WIDTH and LENGTH must have four walls!")}else console.error("rooms with WIDTH must also have LENGTH (and vice versa)");var g=s(m);if(g.length>2)for(var v=0;v<g.length;v++){var y=g[v],E=g[(v+1)%g.length],w=E.components.position.data.x-y.components.position.data.x,b=E.components.position.data.z-y.components.position.data.z,M=Math.atan2(b,w);y.setAttribute("rotation",{x:0,y:-M/Math.PI*180,z:0}),y.object3D.updateMatrixWorld()}}}for(var A=e.el.querySelectorAll("[doorlink]"),x=0;x<A.length;x++){var T=A[x].components.doorlink;if(!T)return;p(T.data.from,T.el),p(T.data.to,T.el)}for(var R=0;R<e.el.children.length;R++){var H=e.el.children[R];if(H.components&&H.components.room){var z=H.components.room.data.outside,k=s(H);if(k.length>2){for(var j=function(){for(var e=k[F],o=k[(F+1)%k.length],n=o.components.position.data.x-e.components.position.data.x,a=o.components.position.data.z-e.components.position.data.z,s=Math.sqrt(n*n+a*a),l=o.components.position.data.y-e.components.position.data.y,m=h(o)-h(e),c=[],p=0;p<e.children.length;p++){var u=e.children[p];u.components&&u.components.doorhole&&c.push(u)}c.sort((function(e,t){return e.components.position.data.x-t.components.position.data.x}));var f=new THREE.Shape;f.moveTo(0,h(e)),f.lineTo(0,0);for(var g=function(){var o=c[v];o.myVerts||(o.myVerts=[]),o.myVerts.length=0;var n=d(c[v]);if(!n)return"continue";for(var r=o.components,i=n.components,a=function(){var n=r.position.data.x+i.doorlink.data.width/2*p,a=n/s*l,c=a+i.doorlink.data.height,d=a+(h(e)+n/s*m)-t;function u(t){var r=new THREE.Vector3(n,t,0);e.object3D.localToWorld(r),o.myVerts.push(r)}c>d&&(c=d),u(a),u(c),p<0?(f.lineTo(n,a),f.lineTo(n,c)):(f.lineTo(n,c),f.lineTo(n,a))},p=-1;p<=1;p+=2)a()},v=0;v<c.length;v++)g();f.lineTo(s,o.components.position.data.y-e.components.position.data.y),f.lineTo(s,o.components.position.data.y-e.components.position.data.y+h(o));var y=new THREE.ShapeGeometry(f);r(y,"x","y",1,1),i(y);var E=e.components.material?e.components.material.material:e.parentNode.components.material.material;e.myMesh?(e.myMesh.geometry=y,e.myMesh.material=E):(e.myMesh=new THREE.Mesh(y,E),e.setObject3D("wallMesh",e.myMesh))},F=0;F<k.length;F++)j();for(var V=[],C=0;C<H.children.length;C++){var D=H.children[C];D.components&&(D.components.floor||D.components.ceiling)&&V.push(D)}for(var S=0;S<V.length;S++){for(var G=V[S],N=G.components.ceiling,P=new THREE.Shape,W=0;W<k.length;W++){var B=k[W],O=B.components.position.data.x,I=B.components.position.data.z;W?P.lineTo(O,I):P.moveTo(O,I)}for(var L=new THREE.ShapeGeometry(P),q=0;q<k.length;q++){var X=k[q],Y=new THREE.Vector3(L.attributes.position.getX(q),L.attributes.position.getY(q),L.attributes.position.getZ(q));Y.set(Y.x,X.components.position.data.y,Y.y),N&&(Y.y+=h(X)),L.attributes.position.setXYZ(q,Y.x,Y.y,Y.z)}var Z=!1;N||(Z=!Z),z&&(Z=!Z),Z&&o(L),r(L,"x","z",N?1:-1,1),i(L),G.myMeshes||(G.myMeshes=[]);var U=N?"ceiling":"floor",J=G.components.material?G.components.material.material:G.parentNode.components.material.material;G.myMeshes[U]?(G.myMeshes[U].geometry=L,G.myMeshes[U].material=J):(G.myMeshes[U]=new THREE.Mesh(L,J),G.setObject3D(U,G.myMeshes[U]))}}}}for(var K=0;K<A.length;K++){var Q=A[K],$=Q.components.doorlink;if($.data.from&&$.data.to){if(!$.data.from.myVerts)return;if(!$.data.to.myVerts)return;for(var _=function(){var e=Q.children[ee];if(!e.components)return"continue";for(var t=["sides","floor","ceiling"],o=function(){var o=t[r];if(!e.components[o])return"continue";var a=e.components.material?e.components.material.material:e.parentNode.components.material.material;if(e.myGeoms||(e.myGeoms=[]),!e.myGeoms[o]){var s=new THREE.BufferGeometry;e.myGeoms[o]=s;var l=new THREE.Mesh(s,a);s.meshRef=l,e.setObject3D(o,l);var m=[];m.push(0,1,2,1,3,2),"sides"===o&&m.push(4,5,6,5,7,6),s.setIndex(m)}var c=e.myGeoms[o];c.meshRef.material=a;var p=[];function d(t){var o=t.clone();e.object3D.worldToLocal(o),p.push(o.x,o.y,o.z)}function h(){c.setAttribute("position",new THREE.BufferAttribute(new Float32Array(p),3))}var u=$.data.from.myVerts,f=$.data.to.myVerts;switch(o){case"floor":d(f[0]),d(f[2]),d(u[2]),d(u[0]),h(),n(c,(function(e,t){return[1-t%2,1-Math.floor(t/2)]}));break;case"ceiling":d(f[3]),d(f[1]),d(u[1]),d(u[3]),h(),n(c,(function(e,t){return[t%2,1-Math.floor(t/2)]}));break;case"sides":d(f[2]),d(f[3]),d(u[0]),d(u[1]),d(u[2]),d(u[3]),d(f[0]),d(f[1]),h(),n(c,(function(e,t){var o=[];return o[0]=Math.floor(t/2),o[1]=t%2,t<4&&(o[0]=1-o[0]),o}))}i(c)},r=0;r<t.length;r++)o()},ee=0;ee<Q.children.length;ee++)_()}}e.dirty=!1})))}});var o={init:function(){this.lastScene=this.el.sceneEl,e(this.lastScene),this.el.addEventListener("componentchanged",t)},update:function(){e(this.lastScene)},remove:function(){e(this.lastScene),this.lastScene=null,this.el.removeEventListener("componentchanged",t)}};return AFRAME.registerComponent("room",Object.assign({schema:{outside:{type:"boolean"},height:{type:"number",default:2.4},width:{type:"number"},length:{type:"number"}}},o)),AFRAME.registerComponent("wall",Object.assign({schema:{height:{type:"number"}}},o)),AFRAME.registerComponent("floor",o),AFRAME.registerComponent("ceiling",o),AFRAME.registerComponent("doorhole",o),AFRAME.registerComponent("doorlink",Object.assign({schema:{from:{type:"selector"},to:{type:"selector"},height:{type:"number",default:2},width:{type:"number",default:.8}}},o)),AFRAME.registerComponent("sides",o),AFRAME.registerPrimitive("rw-room",{defaultComponents:{room:{}},mappings:{outside:"room.outside",height:"room.height",width:"room.width",length:"room.length"}}),AFRAME.registerPrimitive("rw-wall",{defaultComponents:{wall:{}},mappings:{height:"wall.height"}}),AFRAME.registerPrimitive("rw-floor",{defaultComponents:{floor:{}},mappings:{}}),AFRAME.registerPrimitive("rw-ceiling",{defaultComponents:{ceiling:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorhole",{defaultComponents:{doorhole:{}},mappings:{}}),AFRAME.registerPrimitive("rw-doorlink",{defaultComponents:{doorlink:{}},mappings:{from:"doorlink.from",to:"doorlink.to",height:"doorlink.height",width:"doorlink.width"}}),AFRAME.registerPrimitive("rw-sides",{defaultComponents:{sides:{}},mappings:{}}),{}})()));
//# sourceMappingURL=aframe-room-component.min.js.map